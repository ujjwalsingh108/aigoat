-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.all_bse_equity_symbols (
  symbol text NOT NULL,
  instrument_token text NOT NULL,
  exchange text NOT NULL DEFAULT 'BSE'::text,
  type text NOT NULL DEFAULT 'EQ'::text,
  segment text NOT NULL DEFAULT 'BSE'::text,
  company_name text,
  isin text,
  lot_size integer DEFAULT 1,
  tick_size numeric DEFAULT 0.05,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT all_bse_equity_symbols_pkey PRIMARY KEY (symbol)
);
CREATE TABLE public.all_nse_equity_symbols (
  symbol text NOT NULL,
  instrument_token text NOT NULL,
  exchange text NOT NULL DEFAULT 'NSE'::text,
  type text NOT NULL DEFAULT 'EQ'::text,
  segment text NOT NULL DEFAULT 'NSE'::text,
  company_name text,
  isin text,
  lot_size integer DEFAULT 1,
  tick_size numeric DEFAULT 0.05,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT all_nse_equity_symbols_pkey PRIMARY KEY (symbol)
);
CREATE TABLE public.auto_fetch_logs (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  executed_at timestamp with time zone NOT NULL DEFAULT now(),
  success boolean NOT NULL,
  data jsonb,
  config jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT auto_fetch_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.bearish_breakout_bse_eq (
  id bigint NOT NULL DEFAULT nextval('bearish_breakout_bse_eq_id_seq'::regclass),
  symbol text NOT NULL,
  instrument_token text NOT NULL,
  entry_price numeric NOT NULL,
  ema20_5min numeric NOT NULL,
  rsi14_5min numeric,
  volume bigint,
  avg_volume bigint,
  candle_time timestamp with time zone NOT NULL,
  target1 numeric,
  target2 numeric,
  stop_loss numeric,
  probability numeric,
  criteria_met text,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  ai_verdict text,
  ai_confidence numeric,
  ai_reasoning text,
  ai_risk_factors text,
  ai_validated boolean DEFAULT false,
  pattern text,
  pattern_confidence numeric,
  rsi numeric,
  signal_type text,
  volatility numeric,
  target_price numeric,
  CONSTRAINT bearish_breakout_bse_eq_pkey PRIMARY KEY (id)
);
CREATE TABLE public.bearish_breakout_nse_eq (
  id bigint NOT NULL DEFAULT nextval('bearish_breakout_nse_eq_id_seq'::regclass),
  symbol text NOT NULL,
  signal_type text NOT NULL,
  probability numeric NOT NULL,
  criteria_met text NOT NULL,
  daily_ema20 numeric,
  ema20_5min numeric,
  rsi_value numeric,
  volume_ratio numeric,
  predicted_direction text,
  target_price numeric,
  stop_loss numeric,
  confidence numeric,
  created_at timestamp with time zone DEFAULT now(),
  created_by text DEFAULT 'system'::text,
  is_public boolean DEFAULT true,
  current_price numeric,
  pattern_name character varying,
  pattern_confidence numeric CHECK (pattern_confidence IS NULL OR pattern_confidence >= 0::numeric AND pattern_confidence <= 100::numeric),
  pattern_direction text CHECK (pattern_direction IS NULL OR (pattern_direction = ANY (ARRAY['BULLISH'::text, 'BEARISH'::text, 'NEUTRAL'::text]))),
  pattern_breakout_level numeric,
  pattern_category character varying CHECK (pattern_category IS NULL OR (pattern_category::text = ANY (ARRAY['CANDLESTICK'::character varying, 'TRIANGLE'::character varying, 'REVERSAL'::character varying, 'CONTINUATION'::character varying, 'CONSOLIDATION'::character varying]::text[]))),
  detected_patterns jsonb,
  strongest_pattern character varying,
  ai_validation_status character varying,
  ai_verdict character varying,
  ai_confidence numeric,
  ai_reasoning text,
  ai_risk_factors jsonb,
  ai_entry_suggestion text,
  ai_validated_at timestamp with time zone,
  ai_validated boolean DEFAULT false,
  pattern text,
  entry_price numeric,
  rsi numeric,
  volatility numeric,
  CONSTRAINT bearish_breakout_nse_eq_pkey PRIMARY KEY (id)
);
CREATE TABLE public.billing_plans (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  price_cents integer NOT NULL DEFAULT 0,
  currency text DEFAULT 'INR'::text,
  monthly boolean DEFAULT true,
  features jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT billing_plans_pkey PRIMARY KEY (id)
);
CREATE TABLE public.bse_equity_top_1000_symbols (
  symbol text NOT NULL,
  instrument_token text NOT NULL,
  exchange text NOT NULL DEFAULT 'BSE'::text,
  type text NOT NULL DEFAULT 'EQ'::text,
  segment text NOT NULL DEFAULT 'BSE'::text,
  company_name text,
  isin text,
  lot_size integer DEFAULT 1,
  tick_size numeric DEFAULT 0.05,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT bse_equity_top_1000_symbols_pkey PRIMARY KEY (symbol)
);
CREATE TABLE public.bse_fo_signals (
  id bigint NOT NULL DEFAULT nextval('bse_fo_signals_id_seq'::regclass),
  symbol text NOT NULL,
  instrument_token text NOT NULL,
  underlying text NOT NULL,
  instrument_type text NOT NULL,
  expiry date NOT NULL,
  strike numeric,
  option_type text,
  signal_type text NOT NULL,
  entry_price numeric NOT NULL,
  ema20_5min numeric NOT NULL,
  rsi14_5min numeric,
  volume bigint,
  avg_volume bigint,
  candle_time timestamp with time zone NOT NULL,
  target1 numeric,
  target2 numeric,
  stop_loss numeric,
  probability numeric,
  criteria_met integer,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT bse_fo_signals_pkey PRIMARY KEY (id)
);
CREATE TABLE public.bse_fo_symbols (
  symbol text NOT NULL UNIQUE,
  instrument_token text NOT NULL,
  exchange text NOT NULL DEFAULT 'BFO'::text,
  segment text NOT NULL DEFAULT 'BFO-FUT'::text,
  instrument_type text NOT NULL,
  underlying text NOT NULL,
  expiry date NOT NULL,
  strike numeric,
  option_type text,
  lot_size integer NOT NULL,
  tick_size numeric NOT NULL DEFAULT 0.05,
  company_name text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT bse_fo_symbols_pkey PRIMARY KEY (instrument_token)
);
CREATE TABLE public.bse_swing_positional_bearish (
  id bigint NOT NULL DEFAULT nextval('bse_swing_positional_bearish_id_seq'::regclass),
  symbol text NOT NULL,
  signal_type text NOT NULL,
  probability numeric NOT NULL,
  criteria_met integer NOT NULL,
  daily_ema20 numeric,
  daily_sma50 numeric,
  rsi_value numeric,
  volume_ratio numeric,
  weekly_volatility numeric,
  market_cap_rank integer,
  yearly_avg_volume bigint,
  predicted_direction text,
  target_price numeric,
  stop_loss numeric,
  confidence numeric,
  current_price numeric,
  created_at timestamp with time zone DEFAULT now(),
  created_by text DEFAULT 'system'::text,
  is_public boolean DEFAULT true,
  detected_patterns jsonb,
  strongest_pattern text,
  pattern_confidence numeric,
  ai_validation_status text,
  ai_verdict text,
  ai_confidence numeric,
  ai_reasoning text,
  ai_risk_factors text,
  ai_validated boolean DEFAULT false,
  pattern text,
  entry_price numeric,
  CONSTRAINT bse_swing_positional_bearish_pkey PRIMARY KEY (id)
);
CREATE TABLE public.bse_swing_positional_bullish (
  id bigint NOT NULL DEFAULT nextval('bse_swing_positional_bullish_id_seq'::regclass),
  symbol text NOT NULL,
  signal_type text NOT NULL,
  probability numeric NOT NULL,
  criteria_met integer NOT NULL,
  daily_ema20 numeric,
  daily_sma50 numeric,
  rsi_value numeric,
  volume_ratio numeric,
  weekly_volatility numeric,
  market_cap_rank integer,
  yearly_avg_volume bigint,
  predicted_direction text,
  target_price numeric,
  stop_loss numeric,
  confidence numeric,
  current_price numeric,
  created_at timestamp with time zone DEFAULT now(),
  created_by text DEFAULT 'system'::text,
  is_public boolean DEFAULT true,
  detected_patterns jsonb,
  strongest_pattern text,
  pattern_confidence numeric,
  ai_validation_status text,
  ai_verdict text,
  ai_confidence numeric,
  ai_reasoning text,
  ai_risk_factors text,
  ai_validated boolean DEFAULT false,
  pattern text,
  entry_price numeric,
  CONSTRAINT bse_swing_positional_bullish_pkey PRIMARY KEY (id)
);
CREATE TABLE public.bullish_breakout_bse_eq (
  id bigint NOT NULL DEFAULT nextval('bullish_breakout_bse_eq_id_seq'::regclass),
  symbol text NOT NULL,
  instrument_token text NOT NULL,
  entry_price numeric NOT NULL,
  ema20_5min numeric NOT NULL,
  rsi14_5min numeric,
  volume bigint,
  avg_volume bigint,
  candle_time timestamp with time zone NOT NULL,
  target1 numeric,
  target2 numeric,
  stop_loss numeric,
  probability numeric,
  criteria_met text,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  ai_verdict text,
  ai_confidence numeric,
  ai_reasoning text,
  ai_risk_factors text,
  ai_validated boolean DEFAULT false,
  pattern text,
  pattern_confidence numeric,
  rsi numeric,
  signal_type text,
  volatility numeric,
  target_price numeric,
  CONSTRAINT bullish_breakout_bse_eq_pkey PRIMARY KEY (id)
);
CREATE TABLE public.bullish_breakout_nse_eq (
  id bigint NOT NULL DEFAULT nextval('bullish_breakout_nse_eq_id_seq'::regclass),
  symbol text NOT NULL,
  signal_type text NOT NULL,
  probability numeric NOT NULL,
  criteria_met text NOT NULL,
  daily_ema20 numeric,
  ema20_5min numeric,
  rsi_value numeric,
  volume_ratio numeric,
  predicted_direction text,
  target_price numeric,
  stop_loss numeric,
  confidence numeric,
  created_at timestamp with time zone DEFAULT now(),
  created_by text DEFAULT 'system'::text,
  is_public boolean DEFAULT true,
  current_price numeric,
  pattern_name character varying,
  pattern_confidence numeric CHECK (pattern_confidence IS NULL OR pattern_confidence >= 0::numeric AND pattern_confidence <= 100::numeric),
  pattern_direction text CHECK (pattern_direction IS NULL OR (pattern_direction = ANY (ARRAY['BULLISH'::text, 'BEARISH'::text, 'NEUTRAL'::text]))),
  pattern_breakout_level numeric,
  pattern_category character varying CHECK (pattern_category IS NULL OR (pattern_category::text = ANY (ARRAY['CANDLESTICK'::character varying, 'TRIANGLE'::character varying, 'REVERSAL'::character varying, 'CONTINUATION'::character varying, 'CONSOLIDATION'::character varying]::text[]))),
  detected_patterns jsonb,
  strongest_pattern character varying,
  ai_validation_status character varying,
  ai_verdict character varying,
  ai_confidence numeric,
  ai_reasoning text,
  ai_risk_factors jsonb,
  ai_entry_suggestion text,
  ai_validated_at timestamp with time zone,
  ai_validated boolean DEFAULT false,
  pattern text,
  entry_price numeric,
  rsi numeric,
  volatility numeric,
  CONSTRAINT bullish_breakout_nse_eq_pkey PRIMARY KEY (id)
);
CREATE TABLE public.feedback (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  organization_id uuid,
  email text NOT NULL,
  type text NOT NULL,
  detail text NOT NULL,
  attachments jsonb DEFAULT '[]'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT feedback_pkey PRIMARY KEY (id),
  CONSTRAINT feedback_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT feedback_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.historical_prices_bse_equity (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  symbol text NOT NULL,
  date date NOT NULL,
  timestamp timestamp with time zone NOT NULL,
  interval_type text NOT NULL DEFAULT '5min'::text,
  open numeric NOT NULL,
  high numeric NOT NULL,
  low numeric NOT NULL,
  close numeric NOT NULL,
  volume bigint,
  open_interest bigint,
  time text,
  CONSTRAINT historical_prices_bse_equity_pkey PRIMARY KEY (id)
);
CREATE TABLE public.historical_prices_bse_fo (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  symbol text NOT NULL,
  instrument_token text,
  underlying text,
  instrument_type text,
  expiry date,
  strike numeric,
  option_type text,
  date date NOT NULL,
  timestamp timestamp with time zone NOT NULL,
  interval_type text NOT NULL DEFAULT '5min'::text,
  open numeric NOT NULL,
  high numeric NOT NULL,
  low numeric NOT NULL,
  close numeric NOT NULL,
  volume bigint,
  open_interest bigint,
  time text,
  CONSTRAINT historical_prices_bse_fo_pkey PRIMARY KEY (id)
);
CREATE TABLE public.historical_prices_bse_swing_hourly (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  symbol text NOT NULL,
  date date NOT NULL,
  timestamp timestamp with time zone NOT NULL,
  interval_type text NOT NULL DEFAULT 'day'::text,
  open numeric NOT NULL,
  high numeric NOT NULL,
  low numeric NOT NULL,
  close numeric NOT NULL,
  volume bigint,
  open_interest bigint,
  CONSTRAINT historical_prices_bse_swing_hourly_pkey PRIMARY KEY (id)
);
CREATE TABLE public.historical_prices_nse_equity (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  symbol text NOT NULL,
  date date NOT NULL,
  open numeric NOT NULL,
  high numeric NOT NULL,
  low numeric NOT NULL,
  close numeric NOT NULL,
  volume bigint,
  open_interest bigint,
  time text,
  timestamp timestamp with time zone,
  interval_type text DEFAULT '5min'::text,
  CONSTRAINT historical_prices_nse_equity_pkey PRIMARY KEY (id)
);
CREATE TABLE public.historical_prices_nse_fo (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  symbol text NOT NULL,
  instrument_token text,
  underlying text,
  instrument_type text,
  expiry date,
  strike numeric,
  option_type text,
  date date NOT NULL,
  timestamp timestamp with time zone NOT NULL,
  interval_type text NOT NULL DEFAULT '5min'::text,
  open numeric NOT NULL,
  high numeric NOT NULL,
  low numeric NOT NULL,
  close numeric NOT NULL,
  volume bigint,
  open_interest bigint,
  time text,
  CONSTRAINT historical_prices_nse_fo_pkey PRIMARY KEY (id)
);
CREATE TABLE public.historical_prices_nse_swing_hourly (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  symbol text NOT NULL,
  date date NOT NULL,
  timestamp timestamp with time zone NOT NULL,
  interval_type text NOT NULL DEFAULT 'day'::text,
  open numeric NOT NULL,
  high numeric NOT NULL,
  low numeric NOT NULL,
  close numeric NOT NULL,
  volume bigint,
  open_interest bigint,
  CONSTRAINT historical_prices_nse_swing_hourly_pkey PRIMARY KEY (id)
);
CREATE TABLE public.invoices (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  subscription_id uuid,
  invoice_number text NOT NULL UNIQUE,
  status text NOT NULL DEFAULT 'draft'::text,
  amount_cents integer NOT NULL,
  tax_cents integer DEFAULT 0,
  total_cents integer NOT NULL,
  currency text NOT NULL DEFAULT 'INR'::text,
  billing_period_start date NOT NULL,
  billing_period_end date NOT NULL,
  due_date date NOT NULL,
  paid_at timestamp with time zone,
  provider_invoice_id text,
  payment_event_id uuid,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT invoices_pkey PRIMARY KEY (id),
  CONSTRAINT invoices_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT invoices_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.subscriptions(id),
  CONSTRAINT invoices_payment_event_id_fkey FOREIGN KEY (payment_event_id) REFERENCES public.payment_events(id)
);
CREATE TABLE public.kite_tokens (
  id bigint NOT NULL DEFAULT nextval('kite_tokens_id_seq'::regclass),
  access_token text NOT NULL UNIQUE,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  is_active boolean DEFAULT true,
  CONSTRAINT kite_tokens_pkey PRIMARY KEY (id)
);
CREATE TABLE public.nse_equity_top_1000_symbols (
  symbol text NOT NULL,
  instrument_token text NOT NULL,
  exchange text NOT NULL DEFAULT 'NSE'::text,
  type text NOT NULL DEFAULT 'EQ'::text,
  segment text NOT NULL DEFAULT 'NSE'::text,
  company_name text,
  isin text,
  lot_size integer DEFAULT 1,
  tick_size numeric DEFAULT 0.05,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT nse_equity_top_1000_symbols_pkey PRIMARY KEY (symbol)
);
CREATE TABLE public.nse_fo_signals (
  id bigint NOT NULL DEFAULT nextval('nse_fo_signals_id_seq'::regclass),
  symbol text NOT NULL,
  instrument_token text NOT NULL,
  underlying text NOT NULL,
  instrument_type text NOT NULL,
  expiry date NOT NULL,
  strike numeric,
  option_type text,
  signal_type text NOT NULL,
  entry_price numeric NOT NULL,
  ema20_5min numeric NOT NULL,
  rsi14_5min numeric,
  volume bigint,
  avg_volume bigint,
  candle_time timestamp with time zone NOT NULL,
  target1 numeric,
  target2 numeric,
  stop_loss numeric,
  probability numeric,
  criteria_met integer,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  ai_verdict text,
  ai_confidence numeric,
  ai_reasoning text,
  ai_risk_factors text,
  ai_validated boolean DEFAULT false,
  pattern text,
  CONSTRAINT nse_fo_signals_pkey PRIMARY KEY (id)
);
CREATE TABLE public.nse_fo_symbols (
  symbol text NOT NULL UNIQUE,
  instrument_token text NOT NULL,
  exchange text NOT NULL DEFAULT 'NFO'::text,
  segment text NOT NULL DEFAULT 'NFO-FUT'::text,
  instrument_type text NOT NULL,
  underlying text NOT NULL,
  expiry date NOT NULL,
  strike numeric,
  option_type text,
  lot_size integer NOT NULL,
  tick_size numeric NOT NULL DEFAULT 0.05,
  company_name text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT nse_fo_symbols_pkey PRIMARY KEY (instrument_token)
);
CREATE TABLE public.nse_swing_positional_bearish (
  id bigint NOT NULL DEFAULT nextval('swing_positional_bearish_id_seq'::regclass),
  symbol text NOT NULL,
  signal_type text NOT NULL,
  probability numeric NOT NULL,
  criteria_met integer NOT NULL,
  daily_ema20 numeric,
  daily_sma50 numeric,
  rsi_value numeric,
  volume_ratio numeric,
  weekly_volatility numeric,
  market_cap_rank integer,
  yearly_avg_volume bigint,
  predicted_direction text,
  target_price numeric,
  stop_loss numeric,
  confidence numeric,
  current_price numeric,
  created_at timestamp with time zone DEFAULT now(),
  created_by text DEFAULT 'system'::text,
  is_public boolean DEFAULT true,
  detected_patterns jsonb,
  strongest_pattern text,
  pattern_confidence numeric,
  ai_validation_status text,
  ai_verdict text,
  ai_confidence numeric,
  ai_reasoning text,
  ai_risk_factors text,
  ai_validated boolean DEFAULT false,
  pattern text,
  entry_price numeric,
  CONSTRAINT nse_swing_positional_bearish_pkey PRIMARY KEY (id)
);
CREATE TABLE public.nse_swing_positional_bullish (
  id bigint NOT NULL DEFAULT nextval('swing_positional_bullish_id_seq'::regclass),
  symbol text NOT NULL,
  signal_type text NOT NULL,
  probability numeric NOT NULL,
  criteria_met integer NOT NULL,
  daily_ema20 numeric,
  daily_sma50 numeric,
  rsi_value numeric,
  volume_ratio numeric,
  weekly_volatility numeric,
  market_cap_rank integer,
  yearly_avg_volume bigint,
  predicted_direction text,
  target_price numeric,
  stop_loss numeric,
  confidence numeric,
  current_price numeric,
  created_at timestamp with time zone DEFAULT now(),
  created_by text DEFAULT 'system'::text,
  is_public boolean DEFAULT true,
  detected_patterns jsonb,
  strongest_pattern text,
  pattern_confidence numeric,
  ai_validation_status text,
  ai_verdict text,
  ai_confidence numeric,
  ai_reasoning text,
  ai_risk_factors text,
  ai_validated boolean DEFAULT false,
  pattern text,
  entry_price numeric,
  CONSTRAINT nse_swing_positional_bullish_pkey PRIMARY KEY (id)
);
CREATE TABLE public.organization_members (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  user_id uuid,
  role_id integer,
  is_owner boolean DEFAULT false,
  is_active boolean DEFAULT true,
  invited_by uuid,
  joined_at timestamp with time zone DEFAULT now(),
  last_seen_at timestamp with time zone,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT organization_members_pkey PRIMARY KEY (id),
  CONSTRAINT organization_members_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT organization_members_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT organization_members_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.roles(id),
  CONSTRAINT organization_members_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES auth.users(id)
);
CREATE TABLE public.organization_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  key text NOT NULL,
  value jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT organization_settings_pkey PRIMARY KEY (id),
  CONSTRAINT organization_settings_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.organizations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  slug text UNIQUE,
  domain text,
  default_currency text DEFAULT 'INR'::text,
  timezone text,
  region text,
  plan_id uuid,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  deleted_at timestamp with time zone,
  CONSTRAINT organizations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.payment_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  subscription_id uuid,
  event_type text NOT NULL,
  provider text NOT NULL DEFAULT 'payu'::text,
  provider_event_id text UNIQUE,
  amount_cents integer NOT NULL,
  currency text NOT NULL DEFAULT 'INR'::text,
  status text NOT NULL,
  metadata jsonb DEFAULT '{}'::jsonb,
  occurred_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payment_events_pkey PRIMARY KEY (id),
  CONSTRAINT payment_events_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT payment_events_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.subscriptions(id)
);
CREATE TABLE public.profiles (
  id uuid NOT NULL,
  email text,
  full_name text,
  display_name text,
  avatar_url text,
  phone text,
  country_code text,
  timezone text DEFAULT 'Asia/Kolkata'::text,
  locale text DEFAULT 'en'::text,
  bio text,
  metadata jsonb DEFAULT '{}'::jsonb,
  accepted_terms_at timestamp with time zone,
  mfa_enabled boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  deleted_at timestamp with time zone,
  CONSTRAINT profiles_pkey PRIMARY KEY (id),
  CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);
CREATE TABLE public.roles (
  id integer NOT NULL DEFAULT nextval('roles_id_seq'::regclass),
  name text NOT NULL UNIQUE,
  description text,
  CONSTRAINT roles_pkey PRIMARY KEY (id)
);
CREATE TABLE public.subscription_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  subscription_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  plan_id uuid NOT NULL,
  old_plan_id uuid,
  action text NOT NULL,
  status text NOT NULL,
  old_status text,
  effective_date timestamp with time zone NOT NULL,
  changed_by uuid,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT subscription_history_pkey PRIMARY KEY (id),
  CONSTRAINT subscription_history_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.subscriptions(id),
  CONSTRAINT subscription_history_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT subscription_history_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.billing_plans(id),
  CONSTRAINT subscription_history_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES auth.users(id)
);
CREATE TABLE public.subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  plan_id uuid,
  provider_subscription_id text,
  status text,
  started_at timestamp with time zone DEFAULT now(),
  ended_at timestamp with time zone,
  seats integer DEFAULT 1,
  metadata jsonb DEFAULT '{}'::jsonb,
  trial_start_at timestamp with time zone,
  trial_end_at timestamp with time zone,
  current_period_start timestamp with time zone,
  current_period_end timestamp with time zone,
  cancel_at_period_end boolean DEFAULT false,
  canceled_at timestamp with time zone,
  cancellation_reason text,
  last_payment_at timestamp with time zone,
  next_billing_date date,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT subscriptions_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT subscriptions_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.billing_plans(id)
);
CREATE TABLE public.truedata_symbols (
  symbol text NOT NULL,
  name text NOT NULL,
  exchange text NOT NULL,
  type text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  instrument_token text,
  segment text,
  CONSTRAINT truedata_symbols_pkey PRIMARY KEY (symbol)
);
CREATE TABLE public.usage_metrics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  metric text NOT NULL,
  value numeric DEFAULT 0,
  recorded_at timestamp with time zone DEFAULT now(),
  CONSTRAINT usage_metrics_pkey PRIMARY KEY (id),
  CONSTRAINT usage_metrics_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.usage_quotas (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  metric_type text NOT NULL,
  date date NOT NULL DEFAULT CURRENT_DATE,
  count integer DEFAULT 0,
  limit_amount integer,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT usage_quotas_pkey PRIMARY KEY (id),
  CONSTRAINT usage_quotas_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.watchlist_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  watchlist_id uuid NOT NULL,
  symbol text NOT NULL,
  current_price numeric,
  daily_change numeric,
  after_hours_change numeric,
  currency text DEFAULT 'INR'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT watchlist_items_pkey PRIMARY KEY (id),
  CONSTRAINT watchlist_items_watchlist_id_fkey FOREIGN KEY (watchlist_id) REFERENCES public.watchlists(id),
  CONSTRAINT watchlist_items_symbol_fkey FOREIGN KEY (symbol) REFERENCES public.truedata_symbols(symbol)
);
CREATE TABLE public.watchlists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  name text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT watchlists_pkey PRIMARY KEY (id),
  CONSTRAINT watchlists_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.webhook_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  provider text NOT NULL DEFAULT 'payu'::text,
  event_type text NOT NULL,
  event_id text,
  payload jsonb NOT NULL,
  processed boolean DEFAULT false,
  processed_at timestamp with time zone,
  error_message text,
  retry_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT webhook_events_pkey PRIMARY KEY (id)
);